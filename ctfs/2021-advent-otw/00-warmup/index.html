<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta itemprop=name content="Day 0 - Warmup">
<meta itemprop=description content="Challenge Description Due to some Grinchey shenanigans, this year the OverTheWire Advent Bonanza CTF will run from Tuesday December 07 until Sunday December 19, however, as is tradition we have a cosy day0 warmup challenge from Retr0id to keep you busy:
Be sure to keep the flag for when the CTF begins, the flag format is AOTW{???}.
Overview We&rsquo;re given a PNG, but after some investigation, we find it&rsquo;s not just a PNG."><meta itemprop=datePublished content="2021-12-20T15:51:25-06:00">
<meta itemprop=dateModified content="2021-12-20T15:51:25-06:00">
<meta itemprop=wordCount content="3404">
<meta itemprop=keywords content><meta property="og:title" content="Day 0 - Warmup">
<meta property="og:description" content="Challenge Description Due to some Grinchey shenanigans, this year the OverTheWire Advent Bonanza CTF will run from Tuesday December 07 until Sunday December 19, however, as is tradition we have a cosy day0 warmup challenge from Retr0id to keep you busy:
Be sure to keep the flag for when the CTF begins, the flag format is AOTW{???}.
Overview We&rsquo;re given a PNG, but after some investigation, we find it&rsquo;s not just a PNG.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://joe.lothan.net/ctfs/2021-advent-otw/00-warmup/"><meta property="article:section" content="ctfs">
<meta property="article:published_time" content="2021-12-20T15:51:25-06:00">
<meta property="article:modified_time" content="2021-12-20T15:51:25-06:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Day 0 - Warmup">
<meta name=twitter:description content="Challenge Description Due to some Grinchey shenanigans, this year the OverTheWire Advent Bonanza CTF will run from Tuesday December 07 until Sunday December 19, however, as is tradition we have a cosy day0 warmup challenge from Retr0id to keep you busy:
Be sure to keep the flag for when the CTF begins, the flag format is AOTW{???}.
Overview We&rsquo;re given a PNG, but after some investigation, we find it&rsquo;s not just a PNG.">
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/site.webmanifest>
<link rel=mask-icon href=/safari-pinned-tab.svg color>
<link rel="shortcut icon" href=/favicon.ico>
<title>Day 0 - Warmup</title><link rel=stylesheet href=https://joe.lothan.net/css/style.min.eac77496566fd7d5768fd650ddb0b2b181ca6a2d7c5fdd6fe6b8ba4bf47e566f.css integrity="sha256-6sd0llZv19V2j9ZQ3bCysYHKai18X91v5ri6S/R+Vm8=" crossorigin=anonymous>
<link rel=stylesheet href=https://joe.lothan.net/css/custom.css>
</head><body id=page>
<header id=site-header class="animated slideInUp">
<div class="hdr-wrapper section-inner">
<div class=hdr-left>
<div class=site-branding>
<a href=https://joe.lothan.net/>Joe Lothan</a>
</div><nav class="site-nav hide-in-mobile">
<a href=https://joe.lothan.net/ctfs/>CTFs</a>
</nav></div><div class="hdr-right hdr-icons">
<span class="hdr-social hide-in-mobile"><a href=https://github.com/ert-plus target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a><a href=https://twitter.com/ert_plus target=_blank rel="noopener me" title=Twitter><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 3a10.9 10.9.0 01-3.14 1.53 4.48 4.48.0 00-7.86 3v1A10.66 10.66.0 013 4s-4 9 5 13a11.64 11.64.0 01-7 2c9 5 20 0 20-11.5a4.5 4.5.0 00-.08-.83A7.72 7.72.0 0023 3z"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
</div></div></header><div id=mobile-menu class="animated fast">
<ul>
<li><a href=https://joe.lothan.net/ctfs/>CTFs</a></li></ul></div><main class="site-main section-inner thin animated fadeIn faster">
<h1>Day 0 - Warmup</h1><div class=content>
<h2 id=challenge-description>Challenge Description<a href=#challenge-description class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>Due to some Grinchey shenanigans, this year the OverTheWire Advent Bonanza CTF will run from Tuesday December 07 until Sunday December 19, however, as is tradition we have a cosy day0 warmup challenge from Retr0id to keep you busy:</p><p>Be sure to keep the flag for when the CTF begins, the flag format is <code>AOTW{???}</code>.</p><p><img src=images/FFbEREBWQAAsjFk.png alt="day0 challenge"></p><h2 id=overview>Overview<a href=#overview class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>We&rsquo;re given a PNG, but after some investigation, we find it&rsquo;s not <em>just</em> a PNG. It&rsquo;s a bootable drive that runs 16-bit x86 code. The program it runs is a christmas quiz that works by modifying it&rsquo;s own PNG data to display questions and answers. To get the flag you need to answer all the questions correctly.</p><p>Which is nuts, completely crazy, never seen anything like it. It&rsquo;s a really beautiful challenge.</p><h2 id=writeup>Writeup<a href=#writeup class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><h3 id=identifying-polyglots>Identifying Polyglots<a href=#identifying-polyglots class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>Even at first glance, you see something is wrong. I see a picture of Santa and the details for Advent OverTheWire 2021, but the top of the image looks like it&rsquo;s being eaten&mldr; <a href="https://www.youtube.com/watch?v=Az49aNuYeJs">by some Linux or something&mldr;</a></p><p>Checking <code>file</code> and a hexdump:</p><p><img src=images/file-and-hexdump.png alt="file output for image and hexdump"></p><p>A PNG with an 8-bit colormap, hence the palette (<code>PLTE</code>) header. A normal PNG with an 8 bit colormap would use the next 0x300 bytes after <code>PLTE</code> to specify the R,B, and G values for 0x100 pixels of a custom palette.</p><p>But is &ldquo;Booting Stage0&mldr; Loaded Stage1&mldr; Retr0id was here - I hope you like my spaghetti code :P&rdquo; really supposed to be specifing colors? And the repeated <code>0x90</code>s at the start of the <code>PLTE</code> header, looks a bit like a NOP sled&mldr; Wait, is that 0xaa55 at offset 0x1fe? <a href=/ctfs/2021-adversary-quest/proclaimation/>I&rsquo;ve seen that before&mldr;</a></p><p>According to <code>file</code>, my web browser, your web browser, and the twitter uploading form, this is a valid PNG file. But is that <em>all</em> it is? Polyglot files are files that are two filetypes at the same time, say a PDF <em>and</em> a ZIP file. And Retr0id has been known to make <a href=https://github.com/DavidBuchanan314/tweetable-polyglot-png>PNG polyglots</a> before.</p><p><img src=images/identifying-polyglots.png alt="&ldquo;Identifying wood&rdquo; meme photoshopped to be &ldquo;identifying polyglots&rdquo;"></p><pre tabindex=0><code>&gt; file --keep-going FFbEREBWQAAsjFk.png | sed &#39;s/\\012- /\n/g&#39;
FFbEREBWQAAsjFk.png: PNG image data, 511 x 339, 8-bit colormap, non-interlaced
DOS/MBR boot sector
 DOS/MBR boot sector
data
</code></pre><p>Yep, it&rsquo;s a polyglot!</p><p>It&rsquo;s not <em>just</em> a PNG, its a PNG that is also a bootable drive!</p><h3 id=initial-boot>Initial Boot<a href=#initial-boot class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>Let&rsquo;s boot it up with QEMU:</p><p><img src=images/booting-a-png.gif alt="a gif that shows qemu booting the png"></p><p>Wow that&rsquo;s insane! How does it do that?</p><p>When a computer boots, the BIOS looks for a bootable drive. Drives are marked as bootable by having the magic bytes <code>0xaa55</code> at the offset <code>0x1fe</code>, or 510 bytes in. If the BIOS finds one, it loads up the first sector of the drive (the boot sector) at the address <code>0x7c00</code>, points the instruction pointer to the start, and just starts executing x86 instructions.</p><p>The processor starts running these instructions in <a href=https://en.wikipedia.org/wiki/Real_mode>Real Mode</a>:</p><blockquote>
<p>an operating mode that all x86 CPUs support. &mldr;</p></blockquote><blockquote>
<p>There is no memory protection, multitasking, or code privilege levels. &mldr;</p></blockquote><blockquote>
<p>for backward compatibility, all x86 CPUs start in real mode when reset</p></blockquote><p>And talk about backward compatibility: Real Mode was the only mode available in the 8086 chip, released in 1979 (!) and used in the original IBM PC. Protected Mode, with virtual memory and basic privilege levels, was released with the 80286 in 1982, but you had to <em>switch into</em> Protected Mode. To this day, x86 CPUs still start in Real Mode.</p><p><a href=https://github.com/angea/pocorgtfo/blob/master/contents/articles/04-03.pdf>This article</a> from POC||GTFO is a great overview of Real Mode and how OSes boot (and the <a href=https://github.com/angea/pocorgtfo/blob/master/contents/articles/05-06.pdf>follow up</a> is great too).</p><p>So when the PNG boots, this is what the CPU, in 16-bit &ldquo;Real Mode&rdquo;, sees:</p><pre tabindex=0><code>&gt; objdump -M intel -D -b binary -mi386 -Maddr16,data16 FFbEREBWQAAsjFk.png 

FFbEREBWQAAsjFk.png:     file format binary


Disassembly of section .data:

00000000 &lt;.data&gt;:
       0:       89 50 4e                mov    WORD PTR [bx+si+0x4e],dx
       3:       47                      inc    di
       4:       0d 0a 1a                or     ax,0x1a0a
       7:       0a 00                   or     al,BYTE PTR [bx+si]
       9:       00 00                   add    BYTE PTR [bx+si],al
       b:       0d 49 48                or     ax,0x4849
       e:       44                      inc    sp
       f:       52                      push   dx
      10:       00 00                   add    BYTE PTR [bx+si],al
      12:       01 ff                   add    di,di
      14:       00 00                   add    BYTE PTR [bx+si],al
      16:       01 53 08                add    WORD PTR [bp+di+0x8],dx
      19:       03 00                   add    ax,WORD PTR [bx+si]
      1b:       00 00                   add    BYTE PTR [bx+si],al
      1d:       00 f1                   add    cl,dh
      1f:       f5                      cmc    
      20:       19 00                   sbb    WORD PTR [bx+si],ax
      22:       00 03                   add    BYTE PTR [bp+di],al
      24:       00 50 4c                add    BYTE PTR [bx+si+0x4c],dl
      27:       54                      push   sp
      28:       45                      inc    bp
      29:       90                      nop
      2a:       90                      nop
      2b:       90                      nop
      2c:       90                      nop
      2d:       90                      nop
      2e:       eb 5e                   jmp    0x8e
      30:       31 7f 00                xor    WORD PTR [bx+0x0],di
</code></pre><p>So it&rsquo;s ugly, and it doesn&rsquo;t do anything, but this PNG header is valid x86 code, and can be run without error by an x86 CPU on boot.</p><p><img src=images/yarr.jpg alt="a bad pirates of the caribbean meme that says &ldquo;this is by far the worst x86 code my computer has ever run&rdquo; &mldr; &ldquo;but your computer can run it&rdquo;"></p><p>Soon after the <code>PLTE</code> header (<code>50 4c 54 45</code>), when arbitrary bytes can be written while still being a valid PNG, Santa has a NOPs sleigh and a rooftop <code>jmp 0x8e</code> to:</p><pre tabindex=0><code>      86:       33 9e c0 38             xor    bx,WORD PTR [bp+0x38c0]
      8a:       36 6b d5 d3             ss imul dx,bp,0xffd3
      8e:       fc                      cld    
      8f:       fa                      cli    
      90:       31 c0                   xor    ax,ax
      92:       8e d8                   mov    ds,ax
      94:       8e c0                   mov    es,ax
      96:       8e e0                   mov    fs,ax
      98:       8e e8                   mov    gs,ax
      9a:       b4 70                   mov    ah,0x70
      9c:       8e d0                   mov    ss,ax
      9e:       bc f0 ff                mov    sp,0xfff0
      a1:       fb                      sti    
      a2:       c7 06 4c 00 de 7c       mov    WORD PTR ds:0x4c,0x7cde
      a8:       c7 06 4e 00 00 00       mov    WORD PTR ds:0x4e,0x0
      ae:       be 19 7d                mov    si,0x7d19
      b1:       e8 2d 00                call   0xe1
      b4:       8b 0e 48 7c             mov    cx,WORD PTR ds:0x7c48
      b8:       bf 00 7e                mov    di,0x7e00
      bb:       be 01 00                mov    si,0x1
      be:       e8 2c 00                call   0xed
</code></pre><p><img src=images/beginning-to-look-like-x86.jpg alt="a picture of a christmas tree with the text &ldquo;it&rsquo;s beginning to look a lot like an x86 program!&rdquo;"></p><h3 id=first-bites-of-spaghetti>First bites of spaghetti<a href=#first-bites-of-spaghetti class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>To debug this, you can run QEMU with the flags <code>-S -s</code> to stop execution at startup and run a GDB server on port 1234.</p><pre tabindex=0><code>&gt; qemu-system-i386 -S -s -drive file=FFbEREBWQAAsjFk.png
</code></pre><p><img src=images/gdb-fail.png alt="using GDB to debug the program. GDB fails at disassembling some x86 instruction"></p><p>Which works, except when it doesn&rsquo;t. GDB sometimes has a hard time understanding 16 bit x86 instructions, even after running <code>set architecture i8086</code> (though for GDB servers in QEMU, apparently there are a <a href=https://stackoverflow.com/questions/32955887/how-to-disassemble-16-bit-x86-boot-sector-code-in-gdb-with-x-i-pc-it-gets-tr/55246894#55246894>couple more steps</a> I didn&rsquo;t know about). In the past I used <a href=https://ternet.fr/gdb_real_mode.html>this gdb script</a> to better show memory layout, but it still doesn&rsquo;t disassemble the code correctly.</p><p>It is pretty annoying to jump back and forth between gdb and objdump so this time I ended up using radare2, which had no problems decoding 16 bit assembly and interfaced seamlessly with the GDB server. Lets take a look at the start of the program:</p><pre tabindex=0><code>&gt; cat debug.r2
e asm.bits=16
e dbg.bpinmaps=false
db 0x7c8e
db 0x7f60
&gt; r2 -i debug.r2 -b 16 -d gdb://localhost:1234
</code></pre><p><img src=images/r2-start-of-code.png alt="Visual mode of initial code the PNG runs"></p><p>We&rsquo;re still just dealing with the first 512 bytes of the PNG, the boot sector part of the file. The loop in the above code, that repeatedly calls <code>0x7ced</code>, loads in the rest of the file using the <code>IN</code> and <code>OUT</code> instructions (<a href=https://stackoverflow.com/questions/3215878/what-are-in-out-instructions-in-x86-used-for>this</a> was an interesting read on early CPU I/O).</p><p>There are also two calls to <code>0x7ce1</code>, a simple function that prints a string to the display using the <a href=https://en.wikipedia.org/wiki/INT_10H>int 0x10</a> BIOS interrupt.</p><p><img src=images/toe-dipping.png alt="disassembly of print function and example of accessing data location"></p><p>At this point it was my second time running the image file, the first time in a debugger, and I had no idea what surprises the <a href="https://www.youtube.com/watch?v=Omy3BERUd1g">spaghett</a> code had in store.</p><p><img src=images/soon.jpg alt="Tim Heideker as &ldquo;spaghett&rdquo; lookup up from behind a bush excited"></p><h3 id=getting-spooked>Getting spooked<a href=#getting-spooked class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>The program then jumps to <code>0x7f3d</code>, after the 0x300 bytes of PNG&rsquo;s <code>PLTE</code> chunk, to the start of the <code>IDAT</code> chunk. So all the following code being run is the pixels you can actually <em>see</em> on the top of the original file.</p><p>At this point I realized I&rsquo;d get nowhere if I keep single-stepping through the binary. So I started stepping over function calls, moving a bit quicker, and seeing what changes in the output until I found something interesting.</p><p><img src=images/flat-init.png alt="The next few calls"></p><p>The arguments to the print function (<code>0x7ce1</code>) give us some overview. The program calls a function <code>0x81ef</code> that initialize a quiz. If that function doesn&rsquo;t return 0, it then endlessly loops, printing &ldquo;Someone touched my spaghett!&rdquo;.</p><p>If the call does return successfully, it prints a bunch of newline characters ("\n" or <code>0x0a</code>) and calls <code>0x83d9</code>, which prints the beautiful splash screen.</p><p>It then waits for user input with the keyboard interrupt <a href=https://en.wikipedia.org/wiki/INT_16H>int 0x16</a>, calls what I assume are more initialization functions, and then branches depending on what value is stored in the memory location <code>0x7e04</code>.</p><p>Moving even quicker, stepping over function calls, jumping all over the place, just looking for changes in the boot screen, we find that the call to <code>0x82db</code> blocks, with the program now requesting input.</p><p><img src=images/requesting-input.gif alt="a gif that shows the png now requesting input"></p><p>Huh. Requesting input without any prompting is class crackme behavior, which is good because we now have a goal: all we have to do is find out what the correct input is and then we&rsquo;ll get the flag, right?</p><p>But wait, it wasn&rsquo;t prompting for input the first time we ran it. And during subsequent debugging sessions where I was moving a bit slower, hoping to see where the input was stored and how it was checked, I was never asked for input again. What is going on?</p><p>I only realized a couple days later, when when I pulled up the bootable image to show a friend, and it was not the same one I remembered. It looked something like:</p><p><img src=images/wrong.png alt="the image showing wrong answer"></p><pre tabindex=0><code>day0 &gt; mv FFbEREBWQAAsjFk.png wrong.png
day0 &gt; wget --quiet https://pbs.twimg.com/media/FFbEREBWQAAsjFk.png
SSL_INIT
day0 &gt; md5sum FFbEREBWQAAsjFk.png wrong.png
3ec59e440409dabc847841c5c6e9adaf  FFbEREBWQAAsjFk.png
a879b7ce54a38fb1e85e8a706329f716  wrong.png
</code></pre><p><img src=images/spooked.jpg alt="image of tim heideker as spaghett, saying &ldquo;you&rsquo;ve been spooked&rdquo;"></p><h3 id=quiz-time>Quiz time<a href=#quiz-time class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>So the image actually changes when we run it! Lets redownload the original and try running it a few times to see how it changes.</p><pre tabindex=0><code>day0 &gt; qemu-system-x86_64 -drive format=raw,file=FFbEREBWQAAsjFk.png
day0 &gt; display FFbEREBWQAAsjFk.png
</code></pre><p><img src=images/q1.png alt="challenge image with the first question, &ldquo;what is my favorite color&rdquo;"></p><pre tabindex=0><code>day0 &gt; qemu-system-x86_64 -drive format=raw,file=FFbEREBWQAAsjFk.png
</code></pre><p>I get prompted for input, where I answer a bit indecisively, and then:</p><pre tabindex=0><code>day0 &gt; display FFbEREBWQAAsjFk.png
</code></pre><p><img src=images/a1.png alt="challenge image with a joke answer &ldquo;blue, no red, no yelllowww!!&rdquo;"></p><p>And again:</p><pre tabindex=0><code>day0 &gt; qemu-system-x86_64 -drive format=raw,file=FFbEREBWQAAsjFk.png
day0 &gt; display FFbEREBWQAAsjFk.png
</code></pre><p><img src=images/wrong.png alt="the image showing wrong answer"></p><p>So now we actually know the full scope of the challenge. We have to correctly answer the 8 questions of the warmup quiz to get the flag.</p><p>But, c&rsquo;mon man, do we really need to answer all 8 question? We have debugging capability, can&rsquo;t we just find the answer-checking code, and no matter the input, force the checker to return true? Even better, can&rsquo;t we just find the flag-printing code and run it directly?</p><p><img src=images/oh-you-wish.png alt="spaghett looking like, cmon man!"></p><p>If only it were that easy&mldr;</p><h3 id=checking-the-checker>Checking the checker<a href=#checking-the-checker class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>Here are the same initialization functions as above. You can see the function call <code>0x81ef</code> that (I assume) checks the integrity, and if false, will endless loop, printing &ldquo;Someone touched my spaghett!&rdquo; You can also see the call to <code>0x82db</code>, the &ldquo;Provide input&rdquo; function, happens if the value at <code>0x7e04</code> is 1. And after calling it, it changes it to 2.</p><p>Looking at the broader control flow of the main function using radare2&rsquo;s visual graph mode:</p><p><img src=images/init-functions.png alt="A control flow graph of the initialization functions"></p><p>The &ldquo;Initializing Quiz&rdquo; (<code>call 0x81ef</code>) is up top, the infinite loop printing &ldquo;Somone touched my spaghett!&rdquo; happens if it fails, and the call to the &ldquo;Provide Input&rdquo; function (<code>call 0x82db</code>) is in the middle.</p><p>It looks like the value at <code>0x7e04</code> is important - it stores the &ldquo;state&rdquo; of the quiz. If <code>0x7e04</code> is set to 1 then the PNG has a quiz question displayed and on the next run the bootable code asks for the answer with &ldquo;Provide input:&rdquo;, setting <code>0x7e04</code> to 2.</p><p>And if this &ldquo;state&rdquo; value is set to 2, then the PNG has &ldquo;You answered:&rdquo; displayed on it. And when running the code with a state of &ldquo;2&rdquo;, it checks to see if the answer is correct.</p><p>So this must be that &ldquo;checking&rdquo; functionality:</p><p><img src=images/checking-your-answer.png alt="a control flow graph of how the image checks your answer"></p><p>The value at <code>0x7e02</code> stores the current &ldquo;question number&rdquo;. So the above code grabs 4 bytes (a <code>dword</code>) from the array starting at <code>0x7c4e</code> at the index of the question number, and stores it in <code>eax</code>.</p><p>This value is the &ldquo;correct answer&rdquo; for the current question, because it ends up <code>cmp</code>aring it to <code>[di+4]</code>, which (after some Real Mode memory addressing weirdness) points to the <a href=https://en.wikipedia.org/wiki/Cyclic_redundancy_check>CRC</a> at the end of the <code>IDAT</code> <a href=https://www.w3.org/TR/PNG-Structure.html>chunk</a> just before the start of the <code>IEND</code> footer:</p><p><img src=images/checked-value.png alt="location of where the images are checked"></p><p>So after updating the image with the &ldquo;You answered:&rdquo; message and running it again, the program checks if it&rsquo;s the right answer by reusing <em>the same integrity check as the PNG specification itself</em>, (the CRC), to compare it to a correct value.</p><p><img src=images/checking-the-quiz.png alt="the final checks for the whole quiz"></p><p>If the comparison succeeds, another value (<code>[di]</code>) is XORed at an array starting at <code>0x7e06</code>.
If the current &ldquo;question number&rdquo; (<code>0x7e02</code>) is less than 7, it is incremented, the &ldquo;state&rdquo; (<code>0x7e04</code>) is changed to &ldquo;printing a question&rdquo; (1), and the program goes on to print the next question.
If the current question number <em>is</em> 7, then presumably our flag printing function (<code>0x834c</code>) is called.</p><h3 id=santa-wants-milk-and-cookies-not-cheese>Santa wants milk and cookies, not cheese!<a href=#santa-wants-milk-and-cookies-not-cheese class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>&ldquo;Okay this is cute and all, but cut the crap, lets jump to that flag printing function and see the flag&rdquo;</p><p>Naturally that&rsquo;s the first thing I did after identifying it, but after running it, you don&rsquo;t get a valid image back - it&rsquo;s mostly filled with null-bytes and some garbage. Checking the flag printing function with radare2&rsquo;s ghidra decompiler (which I didn&rsquo;t even know would work in real mode until doing this write-up):</p><p><img src=images/flag-printer.png alt="the flag printing function in radare2"></p><p>The first <code>do...while</code> loop here makes a 0x100 long array of bytes <code>0x00, 0x01, 0x02 ... 0xfe, 0xff</code>. Searching for &ldquo;0x100 bytes encryption&rdquo; and it looks like the flag is encrypted with RC4, with the encrypted flag located at <code>0x7c6e</code>, and the key at <code>0x7e06</code>. The key is generated above, from the values at <code>[di]</code> across all 8 correct answers to the quiz.</p><p>To me, this was the real beauty of this challenge. At the beginning it was astonishing that a PNG file could run a program when booted as a hard disk. Near the end, it was astonishing that you actually <em>have</em> to answer all the questions to get the flag. (Or at least most of them, as we&rsquo;ll see)</p><p>So lets answer them! (It took me an embarssingly long time to realize that it is <em>Santa</em> asking the questions)</p><p><img src=images/q1.png alt="question 1: what is my favorite color?"></p><blockquote>
<p>Red</p></blockquote><p><img src=images/q2.png alt="question 2: who is my favorite reigndeer?"></p><blockquote>
<p>Rudolph</p></blockquote><p><img src=images/q3.png alt="question 3: VGhlIGFuc3dlciBpcyBGUk9HUw=="></p><p>(base64 decoded to: &ldquo;The answer is FROGS&rdquo;)</p><blockquote>
<p>FROGS</p></blockquote><p><img src=images/q4.png alt="question 4: Jung vf guvf pvcure pnyyrq?"></p><p>(ROT13 for &ldquo;What is this cipher called?&rdquo;)</p><blockquote>
<p>ROT13</p></blockquote><p><img src=images/q5.png alt="question 5: what is (123^2)/(sqrt(1/4)) "></p><blockquote>
<p>30258</p></blockquote><p><img src=images/q6.png alt="question 6: what cipher encrypted the flag"></p><blockquote>
<p>RC4</p></blockquote><p><img src=images/q7.png alt="question 7: what is my favorite 7-digit prime?"></p><p>Well, crap. I was breezing through it up until this point. But I searched google and it turns out Santa <em>traditionally</em> does not have a favorite 7 digit prime. We might have to brute force this one.</p><h3 id=brute-force-on-quizmas-eve>Brute force on Quizmas Eve<a href=#brute-force-on-quizmas-eve class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><p>48 hours before the CTF ended with almost all of the AOTW challenges released, I took stock of flags I could try to snag before times up. I&rsquo;m a n00b at pwn and that was mostly what was remaining, so I started looking at this warmup challenge again.</p><p>Around 8 hours before time, I got to this point, where I realized I needed to brute force the last few questions. It had been dark outside for a while and I was fading fast.</p><p>There are over half a million 7 digit primes. And question 8 is &ldquo;What’s my password? (Hint: rockyou)&rdquo;, which has tens of millions of entries.</p><p>I quickly patched together a very ugly script to brute force the 7-digit prime using the qemu monitor, sending individual keys using the <code>sendkey</code> command:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>#!/usr/bin/env python3</span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> os
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> sys
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> len(sys<span style=color:#f92672>.</span>argv) <span style=color:#f92672>!=</span> <span style=color:#ae81ff>3</span>:
</span></span><span style=display:flex><span>    print(<span style=color:#e6db74>&#34;usage: ./brute [input.png] [list.txt]&#34;</span>)
</span></span><span style=display:flex><span>    exit(<span style=color:#ae81ff>1</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span><span style=color:#75715e># extracted from offset 0x66 of the png</span>
</span></span><span style=display:flex><span><span style=color:#75715e># or 0x7c4e+4*6 in the binary</span>
</span></span><span style=display:flex><span>target <span style=color:#f92672>=</span> bytes([<span style=color:#ae81ff>0x8d</span>, <span style=color:#ae81ff>0x26</span>, <span style=color:#ae81ff>0x68</span>, <span style=color:#ae81ff>0xf6</span>]) 
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>with</span> open(sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>2</span>]) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>    list <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>readlines()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cmd <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;mkdir imgs2&#34;</span>
</span></span><span style=display:flex><span>print(cmd)
</span></span><span style=display:flex><span>os<span style=color:#f92672>.</span>system(cmd)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> l <span style=color:#f92672>in</span> list:
</span></span><span style=display:flex><span>    filename <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;imgs2/&#34;</span> <span style=color:#f92672>+</span> l<span style=color:#f92672>.</span>strip() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;.png&#34;</span>
</span></span><span style=display:flex><span>    cmd <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;cp &#34;</span> <span style=color:#f92672>+</span> sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34; &#34;</span> <span style=color:#f92672>+</span> filename 
</span></span><span style=display:flex><span>    os<span style=color:#f92672>.</span>system(cmd)
</span></span><span style=display:flex><span>    print(cmd)
</span></span><span style=display:flex><span>    cmd <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;qemu-system-i386 -display none -daemonize --monitor unix:santa_socket,server,nowait -drive format=raw,file=&#34;</span> <span style=color:#f92672>+</span> filename
</span></span><span style=display:flex><span>    print(cmd)
</span></span><span style=display:flex><span>    os<span style=color:#f92672>.</span>system(cmd)
</span></span><span style=display:flex><span>    cmd <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;./sendkeys/sendkeys </span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74>&lt;ret&gt;&#34;</span> <span style=color:#f92672>+</span> l<span style=color:#f92672>.</span>strip() <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;&lt;ret&gt;&lt;ret&gt;</span><span style=color:#ae81ff>\&#34;</span><span style=color:#e6db74> | socat - unix-connect:santa_socket&#34;</span>
</span></span><span style=display:flex><span>    print(cmd)
</span></span><span style=display:flex><span>    os<span style=color:#f92672>.</span>system(cmd)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>with</span> open(filename, <span style=color:#e6db74>&#34;rb&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>        f<span style=color:#f92672>.</span>seek(<span style=color:#ae81ff>0x1c3f0</span>) <span style=color:#75715e># offset of final crc</span>
</span></span><span style=display:flex><span>        crc <span style=color:#f92672>=</span> f<span style=color:#f92672>.</span>read(<span style=color:#ae81ff>4</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> crc <span style=color:#f92672>==</span> target:
</span></span><span style=display:flex><span>            print(<span style=color:#e6db74>&#34;FOUND SANTAS FAVORITE PRIME!!!&#34;</span>)
</span></span><span style=display:flex><span>            print(l)
</span></span><span style=display:flex><span>            exit(<span style=color:#ae81ff>0</span>)
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>else</span>:
</span></span><span style=display:flex><span>            cmd <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;rm &#34;</span> <span style=color:#f92672>+</span> filename
</span></span><span style=display:flex><span>            print(cmd)
</span></span><span style=display:flex><span>            os<span style=color:#f92672>.</span>system(cmd)
</span></span></code></pre></div><p>This method turned out to be very slow. About 1 guess a second. So I broke the list of primes into 10 lists and ran them all in parallel. While that was churning away, I recognized I probably couldn&rsquo;t do rockyou to get Santa&rsquo;s password the same way in time.</p><p>But, if I successfully brute force the answer to question 7, I should have 14 bytes of the 18 byte-long key. And cracking the remaining 2^32 bits wouldn&rsquo;t exactly be <em>fast</em>, but would certainly be faster than running rockyou through my existing script. Here was my cracking program written in go:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;crypto/rc4&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>ciphertext</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>byte</span>{
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>0x29</span>,<span style=color:#ae81ff>0x23</span>,<span style=color:#ae81ff>0xb6</span>,<span style=color:#ae81ff>0x7b</span>,<span style=color:#ae81ff>0x44</span>,<span style=color:#ae81ff>0xa6</span>,<span style=color:#ae81ff>0xf1</span>,<span style=color:#ae81ff>0xda</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x3d</span>,<span style=color:#ae81ff>0x4d</span>,<span style=color:#ae81ff>0xc1</span>,<span style=color:#ae81ff>0x5c</span>,<span style=color:#ae81ff>0x85</span>,<span style=color:#ae81ff>0x01</span>,<span style=color:#ae81ff>0xcc</span>,<span style=color:#ae81ff>0xf8</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0xfc</span>,<span style=color:#ae81ff>0x29</span>,<span style=color:#ae81ff>0xd4</span>,<span style=color:#ae81ff>0x19</span>,<span style=color:#ae81ff>0xfa</span>,<span style=color:#ae81ff>0x9b</span>,<span style=color:#ae81ff>0x0c</span>,<span style=color:#ae81ff>0xf5</span>,
</span></span><span style=display:flex><span>        <span style=color:#ae81ff>0x33</span>,<span style=color:#ae81ff>0x9e</span>,<span style=color:#ae81ff>0xc0</span>,<span style=color:#ae81ff>0x38</span>,<span style=color:#ae81ff>0x36</span>,<span style=color:#ae81ff>0x6b</span>,<span style=color:#ae81ff>0xd5</span>,<span style=color:#ae81ff>0xd3</span>}
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>key_prefix</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>byte</span>{
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>0x0f</span>,<span style=color:#ae81ff>0x53</span>,<span style=color:#ae81ff>0x9a</span>,<span style=color:#ae81ff>0x42</span>,
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>0x3a</span>,<span style=color:#ae81ff>0xf9</span>,<span style=color:#ae81ff>0xfe</span>,<span style=color:#ae81ff>0x19</span>,
</span></span><span style=display:flex><span>		<span style=color:#ae81ff>0x0c</span>,<span style=color:#ae81ff>0xdd</span>,<span style=color:#ae81ff>0x1f</span>,<span style=color:#ae81ff>0xcb</span>,
</span></span><span style=display:flex><span>        <span style=color:#75715e>// Didn&#39;t know these last two bytes until after brute forcing question 7
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>		<span style=color:#ae81ff>0x09</span>,<span style=color:#ae81ff>0x9c</span>}
</span></span><span style=display:flex><span>	
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>key_prefix</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>ciphertext</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>count</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>	
</span></span><span style=display:flex><span>	<span style=color:#75715e>// this is ugly i know I&#39;m moving fast but let me tell you
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#75715e>// it is great practice for vim keybinds.
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>i</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>i</span> &lt; <span style=color:#ae81ff>256</span>; <span style=color:#a6e22e>i</span> <span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>j</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>j</span> &lt; <span style=color:#ae81ff>256</span>; <span style=color:#a6e22e>j</span> <span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>k</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>k</span> &lt; <span style=color:#ae81ff>256</span>; <span style=color:#a6e22e>k</span> <span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>				<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>l</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>l</span> &lt; <span style=color:#ae81ff>256</span>; <span style=color:#a6e22e>l</span> <span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>key</span> <span style=color:#f92672>:=</span> append(<span style=color:#a6e22e>key_prefix</span>, byte(<span style=color:#a6e22e>i</span>), byte(<span style=color:#a6e22e>j</span>), byte(<span style=color:#a6e22e>k</span>), byte(<span style=color:#a6e22e>l</span>))
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>cipher</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>rc4</span>.<span style=color:#a6e22e>NewCipher</span>(<span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>out</span> <span style=color:#f92672>:=</span> make([]<span style=color:#66d9ef>byte</span>, <span style=color:#ae81ff>0x20</span>)
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>cipher</span>.<span style=color:#a6e22e>XORKeyStream</span>(<span style=color:#a6e22e>out</span>, <span style=color:#a6e22e>ciphertext</span>)
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>count</span> <span style=color:#f92672>%</span> <span style=color:#ae81ff>1000000</span> <span style=color:#f92672>==</span> <span style=color:#ae81ff>0</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>count</span>, <span style=color:#e6db74>&#34;trying key:&#34;</span>, <span style=color:#a6e22e>key</span>)
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;with output&#34;</span>, <span style=color:#a6e22e>out</span>)
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>count</span> <span style=color:#f92672>++</span>
</span></span><span style=display:flex><span>					<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>out</span>[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;A&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>out</span>[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;O&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>out</span>[<span style=color:#ae81ff>2</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;T&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>out</span>[<span style=color:#ae81ff>3</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;W&#39;</span> <span style=color:#f92672>&amp;&amp;</span> <span style=color:#a6e22e>out</span>[<span style=color:#ae81ff>4</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;{&#39;</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#e6db74>&#34;FOUND FLAG!!!!!&#34;</span>)
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;out: %s\n&#34;</span>, <span style=color:#a6e22e>out</span>)
</span></span><span style=display:flex><span>						<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>					}
</span></span><span style=display:flex><span>				}
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>I had about 6 hours left. The 10 parallel qemu bruteforcing was running, but very slowly. A rough calculation showed I had about 1/10 chance of guessing Santa&rsquo;s favorite 7 digit prime in time.</p><p>I needed a Christmas miracle. I&rsquo;d been nice this year, right? Before going to sleep, I made sure to leave my browser cookies out. And I woke up early in the morning hoping Santa would leave a flag for me under the Christmas spanning tree.</p><h3 id=final-runtime>Final runtime:<a href=#final-runtime class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h3><pre tabindex=0><code>QEMU 6.1.0 monitor - type &#39;help&#39; for more information
(qemu) sendkey ret
(qemu) sendkey 3
(qemu) sendkey 1
(qemu) sendkey 3
(qemu) sendkey 3
(qemu) sendkey 3
(qemu) sendkey 3
(qemu) sendkey 7
(qemu) sendkey ret
(qemu) sendkey ret
(qemu) FOUND SANTAS FAVORITE PRIME!!!
3133337                                                                                                  
./brute.py q7.png xac  2540.02s user 471.96s system 5% cpu 13:57:10.44 total
</code></pre><p>And cracking the key to get the flag:</p><pre tabindex=0><code>2218000000 trying key: [15 83 154 66 58 249 254 25 12 221 31 203 9 156 132 51 254 128]
with output [203 152 41 235 222 253 17 244 32 186 152 153 183 85 191 61 204 12 252 31 32 245 69 132 173 128 206 32 169 116 97 40]
FOUND FLAG!!!!!
out: AOTW{u_4r3_th3_xm45_qu1zm4st3r}
go run crack2.go  7549.51s user 188.92s system 104% cpu 2:02:51.74 total
</code></pre><p>16 hours total. Not even close.</p><p>I&rsquo;m Jewish, I don&rsquo;t even celebrate Christmas.</p><h2 id=final-notes>Final Notes<a href=#final-notes class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h2><p>This was the best CTF challenge I&rsquo;ve done to date. Very unique and well made, it caused me to say &ldquo;holy shit&rdquo; aloud many times when solving it. Thanks Retr0id!</p><p><img src=images/great-job.png alt="spaghett with &ldquo;great job!&rdquo;"></p><p>Also I found out after the CTF ended, there is a way to run qemu by redirecting stdio to the guest using <code>-nographic</code> which would have sped up the final brute forcing significantly. Good to know for next time.</p><p>I didn&rsquo;t even go into detail about <em>how</em> the program actually updates the image with the input, or how the CRC32 was recalculated, or the value of <code>[di]</code> used for key generation, mostly because I didn&rsquo;t have time to look into it myself. But chatter in the <a href=https://overthewire.org/information/chat.html>OverTheWire Chat</a> shows that other players used the image generation mechanisms to their advantage to brute force, which is pretty cool.</p><p>Finally, there is a cool stunt hacking / demoscene around programming bootloaders and other pieces of software in Real Mode. There are a few POC||GTFO articles with, uhhh&mldr; bootloader POCs to check out (<a href=https://github.com/angea/pocorgtfo/blob/master/contents/articles/03-08.pdf>1</a>,<a href=https://github.com/angea/pocorgtfo/blob/master/contents/articles/11-04.pdf>2</a>).</p><p>I also wrote my first crappy <a href=https://github.com/lothan/DOSword>program in real mode</a> recently, learned a lot from it and found it surprisingly fun. <a href=https://www.amazon.com/Programming-Sector-Games-Toledo-Gutierrez/dp/0359816312>Programming Boot Sector Games by Oscar Toledo D.</a> (aka <a href=https://nanochess.org/>nanochess</a>) is a good intro. I was going to try to make a <a href=https://en.wikipedia.org/wiki/Pentomino#Constructing_rectangular_dimensions>pentomino game</a> bootloader or maybe a <a href=https://en.wikipedia.org/wiki/Peg_solitaire>peg solitaire</a> one but might not have the time, so if this stuff interests you and you need a side-project, you should try it out!</p></div></main><footer id=site-footer class="section-inner thin animated fadeIn faster">
<p>&copy; 2022 <a href=https://joe.lothan.net/>Joe Lothan</a></p><p>
Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://joe.lothan.net/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a>
</p></footer><script src=https://joe.lothan.net/js/bundle.min.8256b8724b9578bbdf6d6f04c894255bc760e78e8a2d60ec0a91ea993acd3b77.js integrity="sha256-gla4ckuVeLvfbW8EyJQlW8dg546KLWDsCpHqmTrNO3c=" crossorigin=anonymous></script>
</body></html>